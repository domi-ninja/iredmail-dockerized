services:
  iredmail:
    image: iredmail/mariadb:stable  # Use stable for production
    container_name: iredmail
    hostname: mail.datenschrauber.ch
    env_file:
      - ./iredmail-docker.prod.conf
    ports:
      # Only mail ports - HTTP/HTTPS handled by Traefik
      - "25:25"     # SMTP
      - "465:465"   # SMTPS
      - "587:587"   # Submission
      - "143:143"   # IMAP
      - "993:993"   # IMAPS
      - "110:110"   # POP3
      - "995:995"   # POP3S
      - "4190:4190" # ManageSieve
    expose:
      - "80"  # Exposed internally for Traefik only
    labels:
      # Enable Traefik
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      
      # HTTP Router - redirect to HTTPS
      - traefik.http.routers.iredmail-web.rule=Host(`mail.datenschrauber.ch`) || Host(`webmail.datenschrauber.ch`) || Host(`admin.datenschrauber.ch`)
      - traefik.http.routers.iredmail-web.entrypoints=web
      - traefik.http.routers.iredmail-web.middlewares=redirect-to-https@file
      
      # HTTPS Router for mail subdomain
      - traefik.http.routers.iredmail-websecure.rule=Host(`mail.datenschrauber.ch`) || Host(`webmail.datenschrauber.ch`) || Host(`admin.datenschrauber.ch`)
      - traefik.http.routers.iredmail-websecure.entrypoints=websecure
      - traefik.http.routers.iredmail-websecure.tls=true
      - traefik.http.routers.iredmail-websecure.tls.certresolver=letsencrypt
      - traefik.http.routers.iredmail-websecure.service=iredmail-service
      - traefik.http.services.iredmail-service.loadbalancer.server.port=80
      
      # Security headers
      - traefik.http.middlewares.iredmail-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.iredmail-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.iredmail-headers.headers.stsPreload=true
      - traefik.http.middlewares.iredmail-headers.headers.forceSTSHeader=true
      - traefik.http.middlewares.iredmail-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.iredmail-headers.headers.browserXssFilter=true
      - traefik.http.routers.iredmail-websecure.middlewares=iredmail-headers
      
    volumes:
      - ./data/backup-mysql:/var/vmail/backup/mysql
      - ./data/mailboxes:/var/vmail/vmail1
      - ./data/mlmmj:/var/vmail/mlmmj
      - ./data/mlmmj-archive:/var/vmail/mlmmj-archive
      - ./data/imapsieve_copy:/var/vmail/imapsieve_copy
      - ./data/custom:/opt/iredmail/custom
      - ./data/ssl:/opt/iredmail/ssl
      - ./data/mysql:/var/lib/mysql
      - ./data/clamav:/var/lib/clamav
      - ./data/sa_rules:/var/lib/spamassassin
      - ./data/postfix_queue:/var/spool/postfix
    restart: unless-stopped
    networks:
      - default
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  default:
    driver: bridge
  dokploy-network:
    external: true
